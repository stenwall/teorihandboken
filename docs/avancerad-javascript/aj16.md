---
layout: default
title: Avancerad funktionalitet i ES.Next
parent: Avancerad JavaScript (AJ)
nav_order: 6
---

# AJ 1.6 Avancerad funktionalitet i ES.Next
{: .fs-9 .fw-700 .no_toc }

## Table of contents
{: .no_toc .text-delta }

- TOC
{:toc}

---

## ECMAScript

JavaScript är en implementation av ECMAScript. ECMAScript är en teknisk standard som beskriver hur andra språk ska fungera, som ett blueprint. Det går alltså att göra egna varianter av ECMAScript än JavaScript (ex ActionScript), men de måste följa ECMAScript.

Dokumentationen kan vara krånglig att läsa, eftersom det mer är en blueprint än en konkret dokumentation av språket.

(Läs mer om ECMAScript [här]({{ site.baseurl }}{% link docs/javascript/js11.md %}))

---

## Vad är ES.Next?

ES.Next är en dynamisk term, som syftar på nästa version av ECMAScript. De är väldigt noga med att allting hela tiden ska vara bakåtkompatibelt, så det tar lång tid att testa och införa nya features.

### Utvecklingsprocessen i TC39

TC39 är ECMA:s tekniska kommitté som går igenom alla proposals/förslag som kommer in.

- En ny feature börjar som en idé från en person, vem som helst kan lägga in en.
- Den som lägger in en idé skriver på ett kontrakt med ECMA kommittén
- Sen följer en process i fyra delar (sk _maturety stages_), det kallas att featuren _mognar_

#### De fyra stegen

- Steg 0 - Strawman
   - idéer för nya tillägg
   - input till specifikationen
- Steg 1 - Proposal
   - formell ansökan för tillägg
   - beskriv lösningen
   - identifiera eventuella svårigheter
- Steg 2 - Draft
   - en version med det som ska in i specifikatioen
   - beskriv syntax och semantik formellt i specifikationens språk
- Steg 3 - Candidate
   - feedback och implementation
- Steg 4 - Finished
   - förslaget klart att läggas till i den formella standarden

---

## 2021 features

Ny funktionalitet som har godkänts av TC39 och implementerats i ECMAScript 2021.

- [`String.prototype.replaceAll()`](#stringprototypereplaceall)
- [`Promise.any()`](#promiseany)
- [Numeric separators](#numeric-separators)
- [Logical assignment operators](#logical-assignment-operators---)
- [`WeakRef` och `FinalizationRegistry`](#weakref-och-finalizationregistry)

### `String.prototype.replaceAll()`

Ersätt alla förekomster av en given sträng (första argumentet) med en annan given sträng (andra argumentet).

#### Exempel[^1]
{:.no_toc}

```js
const myString = 'The quick brown fox jumps over the lazy dog. If the dog reacted, was it really lazy?';

console.log(myString.replaceAll('dog', 'monkey'));

// loggar ut: 'The quick brown fox jumps over the lazy monkey. If the monkey reacted, was it really lazy?'
```

### `Promise.any()`

Tar en array av `Promise`-objekt och itererar över dem. Så fort någon av de givna objekten 'lyckas' (fullfill), så returneras värdet från det promiset. Om inget av objekten lyckas (alla rejectas), så returnas en error.[^2]

`Promise.any()` resolvas alltså alltid med värdet från det *första* promiset som lyckas, även om något annat av promise-objekten misslyckas/rejectas.

#### Exempel[^3]
{:.no_toc}

```js
const promise1 = Promise.reject(0);
const promise2 = new Promise((resolve) => setTimeout(resolve, 100, 'quick'));
const promise3 = new Promise((resolve) => setTimeout(resolve, 500, 'slow'));

const promises = [promise1, promise2, promise3];

Promise.any(promises).then((value) => console.log(value));

// loggar ut: "quick"
```

### Numeric separators

För att öka läsbarheten kan underscores (`_`) användas som numeriska separatorer. Fungerar med vanliga tal, binära tal och hex-tal.

#### Exempel[^4]
{:.no_toc}

```js
// separatorer i decimala tal
1_000_000_000_000
1_050.95

// separatorer i binära tal
0b1010_0001_1000_0101

// separatorer i hex tal
0xA0_B0_C0
```

### Logical assignment operators (`&&=`, `||=`, `??=`)[^5]

Binära operatorer med tilldelningsfunktionalitet.

- `&&=` - om vänstra sidan är truthy så tilldelas den värden på högra sidan
- `||=` - om vänstra sidan är falsy, så tilldelas den värdet på högra sidan
- `??=` - om vänstra sidan är nullish eller undefined, så tilldelas värdet på högra sidan

#### Exempel
{:.no_toc}

```js
let x = 1;
let y = 2;

x &&= y; // om x är truthy blir den y
x ||= y; // om x är falsy blir den y
x ??= y; // om x är nullsih/undefined blir den y
```

### `WeakRef` och `FinalizationRegistry`

Generellt så är referenser till objekt i JS *strong*, vilket betyder att så länge det finns en referens till ett objekt så kommer objektet att finnas kvar och ta upp minne. `WeakRef` skapar en *weak* (svag) referens, som inte håller kvar objektet det referear till i minnet.[^6]

`FinalizationRegistry` används ihop med `WeakRef`, och låter oss registrera en callback som kan köras när objektet vi refererar till försvinner ur minnet.[^7] [^8]

(OBS! Enligt MDN bör dessa bara användas i undantagsfall[^9])

---

## 2022 features

Några features som kommer att komma 2022.

- [Privata metoder](#privata-metoder)
- [Privat åtkomst](#privat-atkomst)
- [Top-level await](#top-level-await)
- [RegExp Match Indices](#regexp-atch-indices)
- [Ergonomic brand checks for Private Fields](#ergonomic-brand-checks-for-private-fields)

### Privata metoder

### Privat åtkomst

### Top-level await

### RegExp match indices

### Ergonomic brand checks for Private Fields

Ber ̈atta lite mer i detalj med n ̊agot kodexempel om en av de nya features fr ̊an 2022. L ̈agg g ̈arna till en diskussion om i vilken situation denna skulle kunna anv ̈andas.

___

## Referenser

[^1]: [MDN - String.prototype.replaceAll()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replaceAll)
[^2]: [MDN - AggregateError](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/AggregateError)
[^3]: [MDN - Promise.any()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/any)
[^4]: [MDN - Lexical grammar](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Lexical_grammar)
[^5]: [TC39 - Assignment Operators](https://tc39.es/ecma262/multipage/ecmascript-language-expressions.html#sec-assignment-operators)
[^6]: [V8.dev - Weak references and finalizers](https://v8.dev/features/weak-references)
[^7]: [StackOverflow - WeakRef and Finalizers](https://stackoverflow.com/a/66723580)
[^8]: [MDN - FinalizationRegistry](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry)
[^9]: [MDN - WeakRef - avoid where possible](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakRef#avoid_where_possible)